{"version":3,"file":"EventDecoder.js","names":["_utils","require","_rskUtils","_abi","EventDecoder","abi","logger","contractInterface","Interface","addSignatureDataToAbi","getEventAbi","topics","sigHash","remove0x","shift","events","filter","i","indexed","signature","getSignatureDataFromAbi","length","Error","eventABI","formatElement","type","decoded","_isIndexed","hash","_isBigNumber","toHexString","res","add0x","Buffer","isBuffer","bufferToHex","toString","toLowerCase","encodeElement","Array","isArray","map","d","join","decodeLog","log","eventFragment","name","args","topic","parseLog","address","parsedArgs","inputs","push","Object","assign","event","JSON","parse","format","e","message","includes","error","freeze","_default","exports","default"],"sources":["../../src/lib/EventDecoder.js"],"sourcesContent":["import { addSignatureDataToAbi, getSignatureDataFromAbi } from './utils'\nimport { remove0x, add0x, bufferToHex } from '@rsksmart/rsk-utils'\nimport { Interface } from '@ethersproject/abi'\n\nfunction EventDecoder (abi, logger) {\n  const contractInterface = new Interface(addSignatureDataToAbi(abi))\n\n  const getEventAbi = topics => {\n    topics = [...topics]\n    const sigHash = remove0x(topics.shift())\n    let events = abi.filter(i => {\n      let { indexed, signature } = getSignatureDataFromAbi(i)\n      return signature === sigHash && indexed === topics.length\n    })\n    if (events.length > 1) throw new Error('Duplicate events in ABI')\n    const eventABI = events[0]\n    return { eventABI, topics }\n  }\n\n  const formatElement = (type, decoded) => {\n    if (decoded._isIndexed) return { _isIndexed: true, hash: decoded.hash }\n    if (decoded._isBigNumber) {\n      return decoded.toHexString()\n    }\n    const res = add0x(Buffer.isBuffer(decoded) ? bufferToHex(decoded) : decoded.toString(16))\n    if (type === 'address' || type === 'address[]') return res.toLowerCase()\n    return res\n  }\n\n  const encodeElement = (type, decoded) => {\n    if (Array.isArray(decoded)) {\n      decoded = decoded.map(d => formatElement(type, d))\n      if (decoded.length === 1) decoded = decoded.join()\n    } else {\n      decoded = formatElement(type, decoded)\n    }\n    return decoded\n  }\n\n  const decodeLog = log => {\n    try {\n      const { eventFragment, name, args, topic } = contractInterface.parseLog(log)\n\n      const { address } = log\n\n      const parsedArgs = []\n\n      for (const i in eventFragment.inputs) {\n        parsedArgs.push(\n          encodeElement(eventFragment.inputs[i].type, args[i])\n        )\n      }\n\n      return Object.assign({}, log, {\n        signature: remove0x(topic),\n        event: name,\n        address,\n        args: parsedArgs,\n        abi: JSON.parse(eventFragment.format('json'))\n      })\n    } catch (e) {\n      // temporary fix to avoid ethers \"no matching event\" error spam\n      if (!e.message.includes('no matching event')) {\n        logger.error(e)\n      }\n      return log\n    }\n  }\n\n  return Object.freeze({ decodeLog, getEventAbi })\n}\n\nexport default EventDecoder\n"],"mappings":"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"}